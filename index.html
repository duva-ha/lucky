<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu√¢n B√≠nh Ng·ªç 2026 - Giviso Mega Luck</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --red: #b71c1c; --gold: #ffeb3b; --dark: #4a0000; --glass: rgba(0,0,0,0.7); }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle, #b71c1c 0%, #4a0000 100%); 
            color: white; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh;
        }
        .container { width: 100%; max-width: 480px; text-align: center; }
        
        /* Form ƒêƒÉng k√Ω */
        #regForm { background: white; padding: 25px; border-radius: 20px; color: #333; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: var(--red); text-align: center; font-size: 1.4rem; }
        input { 
            width: 100%; padding: 12px; margin: 8px 0 18px 0; 
            border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; 
        }
        .btn-reg { 
            width: 100%; padding: 15px; background: var(--red); color: white; 
            border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer;
        }

        /* Th·∫ª th√¥ng tin c√° nh√¢n */
        .personal-card { 
            background: var(--glass); padding: 15px; border-radius: 20px; 
            border: 2px solid var(--gold); margin-bottom: 20px; 
        }
        .my-num-box { font-size: 2.2rem; color: var(--gold); font-weight: 900; letter-spacing: 5px; margin: 10px 0; }
        .kara-info { font-style: italic; color: #ffccbc; border-top: 1px solid rgba(255,235,59,0.3); padding-top: 10px; }

        /* B·∫£ng 6x6 Quay s·ªë */
        .mega-draw-panel { 
            background: rgba(0,0,0,0.8); border-radius: 20px; padding: 15px; 
            border: 1px solid var(--gold); display: none; /* Ch·ªâ hi·ªán khi quay */
        }
        .draw-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 5px 0; border-bottom: 1px dashed rgba(255,215,0,0.2); 
        }
        .row-number { font-family: monospace; font-size: 1.4rem; font-weight: 900; color: #555; letter-spacing: 2px; }
        .active-spin { color: #00ff00; }
        .match-win { color: white; background: #28a745; border-radius: 5px; padding: 0 5px; animation: glow 1s infinite; }

        @keyframes glow { 0% { box-shadow: 0 0 5px #fff; } 50% { box-shadow: 0 0 20px var(--gold); } 100% { box-shadow: 0 0 5px #fff; } }
    </style>
</head>
<body>

<div class="container">
    <div id="regForm">
        <h2>üßß ƒêƒÇNG K√ù T·∫§T NI√äN üßß<br><small>ƒê√≥n Xu√¢n B√≠nh Ng·ªç 2026</small></h2>
        <label><b>H·ªå V√Ä T√äN</b></label>
        <input type="text" id="nameInp" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        
        <label><b>B√ÄI H√ÅT KARAOKE (N·∫øu c√≥)</b></label>
        <input type="text" id="songInp" placeholder="T√™n b√†i h√°t b·∫°n mu·ªën g√≥p vui...">
        
        <button class="btn-reg" onclick="register()">ƒêƒÇNG K√ù THAM GIA</button>
    </div>

    <div id="mainUI" style="display: none;">
        <div class="personal-card">
            <div id="displayIdentity" style="font-weight:bold; color: var(--gold); text-transform: uppercase;">T√™n Ng∆∞·ªùi Tham Gia</div>
            <div style="font-size: 0.7rem; color: #ccc; margin-top:5px;">M√É S·ªê MAY M·∫ÆN C·ª¶A B·∫†N:</div>
            <div id="displayMyNum" class="my-num-box">000000</div>
            <div id="displaySong" class="kara-info">Karaoke: Ch∆∞a ƒëƒÉng k√Ω</div>
        </div>

        <div id="panelLucky" class="mega-draw-panel">
            <div style="font-size: 0.9rem; font-weight: 900; color: var(--gold); margin-bottom: 10px;">üèÜ 6 D√ÉY S·ªê TR√öNG GI·∫¢I üèÜ</div>
            <div id="drawRows">
                <div class="draw-row"><small>G1</small> <span id="win1" class="row-number">------</span></div>
                <div class="draw-row"><small>G2</small> <span id="win2" class="row-number">------</span></div>
                <div class="draw-row"><small>G3</small> <span id="win3" class="row-number">------</span></div>
                <div class="draw-row"><small>G4</small> <span id="win4" class="row-number">------</span></div>
                <div class="draw-row"><small>G5</small> <span id="win5" class="row-number">------</span></div>
                <div class="draw-row"><small>G6</small> <span id="win6" class="row-number">------</span></div>
            </div>
            <div id="luckyStatus" style="margin-top:10px; font-weight:bold; color:#00ff00;"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");

    async function register() {
        const name = document.getElementById('nameInp').value.trim();
        const song = document.getElementById('songInp').value.trim() || "Kh√¥ng ƒëƒÉng k√Ω";
        if(!name) return alert("Vui l√≤ng nh·∫≠p h·ªç t√™n!");

        const myNum = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
        
        // L·∫•y STT ƒëƒÉng k√Ω
        const snap = await db.collection("participants").get();
        const stt = snap.size + 1;

        await db.collection("participants").add({
            name: name,
            song: song,
            number: myNum,
            stt: stt,
            ts: Date.now()
        });

        localStorage.setItem('giviso_name', name);
        localStorage.setItem('giviso_song', song);
        localStorage.setItem('giviso_num', myNum);
        localStorage.setItem('giviso_stt', stt);

        showUI(name, song, myNum, stt);
    }

    function showUI(name, song, num, stt) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('displayIdentity').innerText = `#${stt} - ${name}`;
        document.getElementById('displayMyNum').innerText = num;
        document.getElementById('displaySong').innerText = "Karaoke: " + song;
        listenSystem();
    }

    function listenSystem() {
        db.collection("system_status").doc("current_draw").onSnapshot(async d => {
            if(!d.exists) return;
            const data = d.data();
            
            if(data.status === "SPINNING" && data.winners) {
                document.getElementById('panelLucky').style.display = 'block';
                runMegaSpinHS(data.winners);
            }
        });
    }

    async function runMegaSpinHS(winners) {
        spinSound.play().catch(()=>{});
        document.getElementById('luckyStatus').innerText = "‚ö° ƒêANG QUAY S·ªê...";
        const myNum = localStorage.getItem('giviso_num');

        let promises = winners.map((win, i) => {
            const el = document.getElementById(`win${i+1}`);
            el.classList.add('active-spin');
            el.classList.remove('match-win');
            
            return new Promise(async (res) => {
                let start = Date.now();
                let duration = 2000 + i * 800; // Kh·ªõp v·ªõi m√°y th·∫ßy

                while(Date.now() - start < duration) {
                    el.innerText = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
                    await new Promise(r => setTimeout(r, 70));
                }
                el.innerText = win.number;
                el.classList.remove('active-spin');
                if(win.number === myNum) {
                    el.classList.add('match-win');
                    winSound.play();
                    document.getElementById('luckyStatus').innerText = "üéä CH√öC M·ª™NG B·∫†N ƒê√É TR√öNG GI·∫¢I! üéä";
                }
                res();
            });
        });
        await Promise.all(promises);
        spinSound.pause();
    }

    window.onload = () => {
        const n = localStorage.getItem('giviso_name');
        if(n) showUI(n, localStorage.getItem('giviso_song'), localStorage.getItem('giviso_num'), localStorage.getItem('giviso_stt'));
    };
</script>
</body>
</html>
