<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu√¢n B√≠nh Ng·ªç 2026 - Giviso Mega Luck</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --red: #b71c1c; --gold: #ffeb3b; --dark: #4a0000; --glass: rgba(0,0,0,0.85); }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle, #b71c1c 0%, #4a0000 100%); 
            color: white; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh;
        }
        .container { width: 100%; max-width: 480px; text-align: center; }
        
        /* Form ƒêƒÉng k√Ω */
        #regForm { background: white; padding: 25px; border-radius: 20px; color: #333; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: var(--red); text-align: center; font-size: 1.4rem; line-height: 1.4; }
        label { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--red); outline: none; }
        .btn-reg { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(183, 28, 28, 0.4); }

        /* Th·∫ª th√¥ng tin c√° nh√¢n */
        .personal-card { background: var(--glass); padding: 15px; border-radius: 20px; border: 2px solid var(--gold); margin-bottom: 15px; position: relative; overflow: hidden; }
        .my-num-box { font-size: 2.5rem; color: var(--gold); font-weight: 900; letter-spacing: 5px; margin: 10px 0; }
        .class-info { font-weight: bold; color: #ffccbc; border-top: 1px solid rgba(255,235,59,0.3); padding-top: 8px; font-size: 1rem; }

        /* Giao di·ªán quay s·ªë */
        #panelLucky { display: none; margin-top: 10px; }
        .winner-row { 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            background: rgba(0,0,0,0.4); padding: 8px; border-radius: 12px; 
            margin-bottom: 8px; border: 1px solid rgba(255,235,59,0.2);
        }
        .row-label { font-size: 0.7rem; font-weight: 900; color: var(--gold); min-width: 40px; text-align: left; }
        .slot-group { display: flex; gap: 3px; }
        .slot { 
            width: 36px; height: 50px; background: #000; border: 1px solid #444; border-radius: 6px; 
            font-size: 1.8rem; font-weight: 900; display: flex; align-items: center; justify-content: center; color: #444;
        }
        .spinning { color: #00ff00; border-color: #00ff00; }
        .final { color: white; border-color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .match-row { background: rgba(40, 167, 69, 0.6); border-color: #28a745; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #luckyStatus { font-weight: bold; font-size: 1.1rem; color: #00ff00; margin-top: 15px; min-height: 1.2em; text-shadow: 0 0 5px #000; }
    </style>
</head>
<body>

<div class="container">
    <div id="regForm">
        <h2>üßß ƒêƒÇNG K√ù NH·∫¨N S·ªê üßß<br><small>T·∫•t Ni√™n B√≠nh Ng·ªç 2026</small></h2>
        
        <label>H·ªç v√† T√™n</label>
        <input type="text" id="nameInp" placeholder="Nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n...">
        
        <label>L·ªõp</label>
        <input type="text" id="classInp" placeholder="V√≠ d·ª•: 10A7, 12A1...">
        
        <label>M√£ x√°c th·ª±c c√° nh√¢n</label>
        <input type="text" id="codeInp" placeholder="Nh·∫≠p m√£ th·∫ßy cung c·∫•p..." style="text-transform: uppercase;">
        
        <button class="btn-reg" onclick="register()">X√ÅC NH·∫¨N ƒêƒÇNG K√ù</button>
        <p style="font-size: 0.7rem; color: #999; margin-top: 10px; text-align: center;">* M·ªói m√£ ch·ªâ ƒë∆∞·ª£c s·ª≠ d·ª•ng m·ªôt l·∫ßn duy nh·∫•t.</p>
    </div>

    <div id="mainUI" style="display: none;">
        <div class="personal-card">
            <div id="displayIdentity" style="font-weight:bold; color: var(--gold); text-transform: uppercase; font-size: 1.2rem;">#0 - T√™n</div>
            <div style="font-size: 0.7rem; color: #ccc; margin-top: 10px;">M√É S·ªê MAY M·∫ÆN C·ª¶A B·∫†N:</div>
            <div id="displayMyNum" class="my-num-box">000000</div>
            <div id="displayClass" class="class-info">L·ªõp: </div>
        </div>

        <div id="panelLucky">
            <div id="megaUI"></div>
            <div id="luckyStatus">ƒêang ch·ªù th·∫ßy b·∫Øt ƒë·∫ßu...</div>
        </div>
    </div>
</div>

<script>
    // C·∫•u h√¨nh Firebase (Gi·ªØ nguy√™n c·ªßa th·∫ßy)
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");
    spinSound.loop = true;

    // Kh·ªüi t·∫°o khung 6 gi·∫£i th∆∞·ªüng
    const megaUI = document.getElementById('megaUI');
    for (let r = 1; r <= 6; r++) {
        megaUI.innerHTML += `
            <div class="winner-row" id="row${r}">
                <div class="row-label">GI·∫¢I ${r}</div>
                <div class="slot-group">
                    ${Array(6).fill(0).map((_, s) => `<div id="r${r}s${s+1}" class="slot">0</div>`).join('')}
                </div>
            </div>`;
    }

    async function register() {
        const name = document.getElementById('nameInp').value.trim();
        const className = document.getElementById('classInp').value.trim();
        const code = document.getElementById('codeInp').value.trim().toUpperCase();

        if(!name || !className || !code) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");

        try {
            // 1. Ki·ªÉm tra m√£ c√≥ t·ªìn t·∫°i trong kho m√£ kh√¥ng
            const codeCheck = await db.collection("unused_codes").doc(code).get();
            if(!codeCheck.exists) {
                alert("M√£ x√°c th·ª±c kh√¥ng ƒë√∫ng!");
                return;
            }

            // 2. Ki·ªÉm tra m√£ ƒë√£ b·ªã ai d√πng ch∆∞a
            const usedCheck = await db.collection("participants").where("accessCode", "==", code).get();
            if(!usedCheck.empty) {
                alert("M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng r·ªìi!");
                return;
            }

            // 3. H·ª£p l·ªá -> Ti·∫øn h√†nh ƒëƒÉng k√Ω
            const myNum = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
            const snap = await db.collection("participants").get();
            const stt = snap.size + 1;

            await db.collection("participants").add({
                name, className, number: myNum, stt, accessCode: code, ts: Date.now()
            });

            // L∆∞u tr·∫°ng th√°i v√†o m√°y h·ªçc sinh
            localStorage.setItem('giviso_name', name);
            localStorage.setItem('giviso_class', className);
            localStorage.setItem('giviso_num', myNum);
            localStorage.setItem('giviso_stt', stt);

            showUI(name, className, myNum, stt);
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi: " + e.message);
        }
    }

    function showUI(name, className, num, stt) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('displayIdentity').innerText = `#${stt} - ${name}`;
        document.getElementById('displayMyNum').innerText = num;
        document.getElementById('displayClass').innerText = "L·ªõp: " + className;
        listenSystem();
    }

    function listenSystem() {
        db.collection("system_status").doc("current_draw").onSnapshot(d => {
            if(!d.exists) return;
            const data = d.data();
            if(data.status === "SPINNING" && data.winners) {
                document.getElementById('panelLucky').style.display = 'block';
                runMegaSpinHS(data.winners);
            }
        });
    }

    async function runMegaSpinHS(winners) {
        spinSound.play().catch(()=>{});
        document.getElementById('luckyStatus').innerText = "‚ö° ƒêANG QUAY TH∆Ø·ªûNG...";
        const myNum = localStorage.getItem('giviso_num');

        for(let r=1; r<=6; r++) document.getElementById(`row${r}`).classList.remove('match-row');

        let promises = winners.map((winner, rIdx) => {
            return new Promise(async (resolve) => {
                const r = rIdx + 1;
                const winNum = winner.number;
                
                for (let s = 1; s <= 6; s++) {
                    const el = document.getElementById(`r${r}s${s}`);
                    el.classList.add('spinning'); el.classList.remove('final');
                    let start = Date.now();
                    while (Date.now() - start < (1500 + rIdx * 500 + s * 150)) {
                        el.innerText = Math.floor(Math.random() * 10);
                        await new Promise(res => setTimeout(res, 50));
                    }
                    el.innerText = winNum[s-1];
                    el.classList.remove('spinning'); el.classList.add('final');
                }

                if(winNum === myNum) {
                    document.getElementById(`row${r}`).classList.add('match-row');
                    document.getElementById('luckyStatus').innerText = "üéä CH√öC M·ª™NG! B·∫†N ƒê√É TR√öNG GI·∫¢I " + r + " üéä";
                    winSound.play();
                }
                resolve();
            });
        });

        await Promise.all(promises);
        spinSound.pause();
    }

    window.onload = () => {
        const n = localStorage.getItem('giviso_name');
        if(n) showUI(n, localStorage.getItem('giviso_class'), localStorage.getItem('giviso_num'), localStorage.getItem('giviso_stt'));
    };
</script>
</body>
</html>
