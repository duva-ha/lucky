<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");
    spinSound.loop = true;

    // Bi·∫øn qu·∫£n l√Ω tr·∫°ng th√°i quay ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    let isSpinning = false;

    window.onload = () => {
        const n = localStorage.getItem('studentName'), 
              c = localStorage.getItem('studentClass'), 
              num = localStorage.getItem('myLuckyNumber');
        if(n && num) showUI(n, c, num);
        listenSystem();
    };

    function register() {
        const n = document.getElementById('nameInp').value, 
              c = document.getElementById('classInp').value;
        if(!n || !c) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        const num = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
        db.collection("participants").add({ name: n, class: c, number: num, ts: Date.now() });
        localStorage.setItem('studentName', n); 
        localStorage.setItem('studentClass', c); 
        localStorage.setItem('myLuckyNumber', num);
        showUI(n, c, num);
    }

    function showUI(n, c, num) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('displayIdentity').innerText = n.toUpperCase() + " - " + c.toUpperCase();
        document.getElementById('displayMyNum').innerText = num;
    }

    function listenSystem() {
        db.collection("system_status").doc("current_draw").onSnapshot(async d => {
            if(!d.exists) return;
            const data = d.data();
            
            if(data.status === "SPINNING" && data.winners && !isSpinning) {
                // K√≠ch ho·∫°t quay ƒë·ªìng b·ªô 6 d√≤ng
                runMegaSpinHS(data.winners);
            }
        });
    }

    async function runMegaSpinHS(winners) {
        isSpinning = true;
        spinSound.currentTime = 0;
        spinSound.play().catch(()=>{});
        document.getElementById('luckyStatus').innerText = "üßß ƒêANG ƒê·ªíNG B·ªò QUAY S·ªê...";
        document.getElementById('luckyStatus').style.color = "#00ff00";

        const myNum = localStorage.getItem('myLuckyNumber');

        // Ch·∫°y hi·ªáu ·ª©ng quay cho c·∫£ 6 d√≤ng ƒë·ªìng th·ªùi
        let hsPromises = winners.map((win, i) => {
            const el = document.getElementById(`win${i+1}`);
            el.classList.add('active');
            el.classList.remove('match'); // Reset m√†u n·∫øu quay l∆∞·ª£t m·ªõi
            
            return new Promise(async (resolve) => {
                let start = Date.now();
                // Th·ªùi gian d·ª´ng kh·ªõp v·ªõi m√°y th·∫ßy: D√≤ng i d·ª´ng sau (2000 + i*800 + 1200)ms
                // Ch√∫ng ta tr·ª´ b·ªõt m·ªôt ch√∫t ƒë·ªÉ HS th·∫•y s·ªë d·ª´ng tr∆∞·ªõc m√°y th·∫ßy 1 nh·ªãp
                let duration = 1800 + i * 800; 

                while(Date.now() - start < duration) {
                    // Nh·∫£y s·ªë ng·∫´u nhi√™n 6 ch·ªØ s·ªë
                    el.innerText = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
                    await new Promise(r => setTimeout(r, 60));
                }

                // D·ª´ng ƒë√∫ng s·ªë tr√∫ng gi·∫£i i
                el.innerText = win.number;
                el.classList.remove('active');
                
                // Ki·ªÉm tra xem m√£ c·ªßa m√¨nh c√≥ kh·ªõp v·ªõi gi·∫£i n√†y kh√¥ng
                if(win.number === myNum) {
                    el.classList.add('match');
                    document.getElementById('luckyStatus').innerText = "üéä B·∫†N ƒê√É TR√öNG GI·∫¢I " + (i+1) + "! üéä";
                    winSound.play();
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                }
                resolve();
            });
        });

        await Promise.all(hsPromises);
        
        spinSound.pause();
        isSpinning = false; // M·ªü kh√≥a cho l∆∞·ª£t quay ti·∫øp theo

        // Ki·ªÉm tra t·ªïng qu√°t sau khi c·∫£ 6 d√≤ng ƒë√£ d·ª´ng
        const anyMatch = winners.some(w => w.number === myNum);
        if(!anyMatch) {
            document.getElementById('luckyStatus').innerText = "CH√öC B·∫†N MAY M·∫ÆN L·∫¶N SAU!";
            document.getElementById('luckyStatus').style.color = "#aaa";
        }
    }
</script>
