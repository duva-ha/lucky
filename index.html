<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Lucky Draw - H·ªçc Sinh</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #1a1a1a; --card: #2d2d2d; --accent: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; margin: 0; display: flex; justify-content: center; padding: 20px; }
        
        .container { width: 100%; max-width: 450px; text-align: center; }
        
        /* KHU V·ª∞C HI·ªÇN TH·ªä S·ªê C·ª¶A B·∫¢N TH√ÇN */
        .my-status-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #444; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .my-number { font-size: 2.2rem; color: var(--accent); font-weight: 900; letter-spacing: 4px; }

        /* GIAO DI·ªÜN 6 L·ªíNG S·ªê ƒê·ªíNG B·ªò V·ªöI GV */
        .live-draw-area { margin: 30px 0; }
        .slot-container { display: flex; justify-content: center; gap: 6px; margin-top: 15px; }
        .slot { background: #000; width: 15%; height: 75px; display: flex; justify-content: center; align-items: center; font-size: 2.8rem; font-weight: 900; color: #333; border-radius: 10px; border: 2px solid #444; transition: all 0.1s; }
        
        /* Hi·ªáu ·ª©ng tr·∫°ng th√°i */
        .spinning { color: #00ff00; border-color: #00ff00; box-shadow: 0 0 15px rgba(0,255,0,0.2); }
        .final { color: white; border-color: var(--accent); text-shadow: 0 0 10px var(--accent); }

        .status-text { margin-top: 20px; font-size: 1.1rem; color: var(--accent); font-weight: bold; min-height: 1.6em; }

        /* FORM ƒêƒÇNG K√ù BAN ƒê·∫¶U */
        #regForm { background: white; padding: 30px; border-radius: 25px; color: #333; text-align: left; }
        input { width: 100%; padding: 15px; margin: 10px 0 20px 0; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-reg { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="mainUI" style="display: none;">
        <div class="my-status-card">
            <div class="label">S·ªë may m·∫Øn c·ªßa em</div>
            <div id="mySavedNumber" class="my-number">------</div>
        </div>

        <div class="live-draw-area">
            <div class="label">K·∫øt qu·∫£ tr·ª±c ti·∫øp t·ª´ Th·∫ßy</div>
            <div class="slot-container">
                <div id="b1" class="slot">0</div>
                <div id="b2" class="slot">0</div>
                <div id="b3" class="slot">0</div>
                <div id="b4" class="slot">0</div>
                <div id="b5" class="slot">0</div>
                <div id="b6" class="slot">0</div>
            </div>
        </div>
        <div id="statusMsg" class="status-text">ƒêang ch·ªù th·∫ßy quay s·ªë...</div>
    </div>

    <div id="regForm">
        <h2 style="margin: 0 0 10px 0; color: var(--primary)">ƒêƒÇNG K√ù QUAY S·ªê</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 25px;">Nh·∫≠n m√£ ng·∫´u nhi√™n ƒë·ªÉ sƒÉn qu√†</p>
        
        <label style="font-weight: bold; font-size: 0.8rem;">H·ªå V√Ä T√äN</label>
        <input type="text" id="studentName" placeholder="Nh·∫≠p t√™n c·ªßa em">
        
        <label style="font-weight: bold; font-size: 0.8rem;">L·ªöP</label>
        <input type="text" id="studentClass" value="10A7">
        
        <button class="btn-reg" id="btnAction" onclick="register()">NH·∫¨N M√É & THEO D√ïI</button>
    </div>
</div>

<script>
    // 1. C·∫•u h√¨nh Firebase (Gi·ªëng h·ªát trang Gi√°o vi√™n)
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
        storageBucket: "chamtn-26e8f.firebasestorage.app",
        messagingSenderId: "130850297017",
        appId: "1:130850297017:web:05913bb70050cd32593768",
        measurementId: "G-Y1L9DC9DZS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    let isSpinning = false;

    window.onload = () => {
        const savedNum = localStorage.getItem('myLuckyNumber');
        if (savedNum) {
            showMainUI(savedNum);
        }
        listenToTeacher(); // Lu√¥n l·∫Øng nghe t√≠n hi·ªáu t·ª´ th·∫ßy
    };

    function showMainUI(num) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('mySavedNumber').innerText = num;
    }

    // 2. L·∫ÆNG NGHE T√çN HI·ªÜU QUAY S·ªê T·ª™ GI√ÅO VI√äN
    function listenToTeacher() {
        db.collection("system_status").doc("current_draw").onSnapshot(async (doc) => {
            if (!doc.exists) return;
            const data = doc.data();
            
            // N·∫øu th·∫ßy b·∫•m n√∫t Quay b√™n Admin
            if (data.status === "SPINNING" && !isSpinning) {
                isSpinning = true;
                await syncSpinEffect(data.winningNumber, data.winnerName);
                isSpinning = false;
            }
        });
    }

    // 3. HI·ªÜU ·ª®NG QUAY S·ªê ƒê·ªíNG B·ªò TR√äN ƒêI·ªÜN THO·∫†I
    async function syncSpinEffect(winNum, winnerName) {
        document.getElementById('statusMsg').innerText = "‚ö° ƒêANG QUAY S·ªê...";
        
        // Reset l·ªìng quay tr√™n m√°y HS
        for(let i=1; i<=6; i++) {
            const el = document.getElementById('b' + i);
            el.innerText = "0";
            el.classList.remove('final', 'spinning');
        }

        // Quay t·ª´ng l·ªìng kh·ªõp th·ªùi gian v·ªõi Admin (3s, 3.5s, 4s...)
        for (let i = 0; i < 6; i++) {
            const el = document.getElementById('b' + (i + 1));
            el.classList.add('spinning');
            
            let startTime = Date.now();
            let duration = 3000 + (i * 500); 
            
            while (Date.now() - startTime < duration) {
                el.innerText = Math.floor(Math.random() * 10);
                await sleep(60);
            }
            
            el.innerText = winNum[i];
            el.classList.remove('spinning');
            el.classList.add('final');
        }

        // 4. KI·ªÇM TRA K·∫æT QU·∫¢ C√Å NH√ÇN
        const myNum = localStorage.getItem('myLuckyNumber');
        if (myNum === winNum) {
            document.getElementById('statusMsg').innerHTML = "üåü CH√öC M∆ØNG! EM ƒê√É TR√öNG GI·∫¢I! üåü";
            // Rung ƒëi·ªán tho·∫°i b√°o hi·ªáu
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
        } else {
            document.getElementById('statusMsg').innerText = "Ng∆∞·ªùi may m·∫Øn: " + winnerName;
        }
    }

    // 5. H√ÄM ƒêƒÇNG K√ù NH·∫¨N M√É
    async function register() {
        const name = document.getElementById('studentName').value.trim();
        const sClass = document.getElementById('studentClass').value.trim();
        if (!name) return alert("Em nh·∫≠p h·ªç t√™n ƒë·ªÉ th·∫ßy bi·∫øt ai tr√∫ng nh√©!");

        const btn = document.getElementById('btnAction');
        btn.disabled = true;
        btn.innerText = "ƒêANG NH·∫¨N M√É...";

        try {
            let isUnique = false;
            let randomNum = "";
            
            // C·∫•p m√£ 6 s·ªë ng·∫´u nhi√™n kh√¥ng tr√πng
            while (!isUnique) {
                randomNum = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                const check = await db.collection("participants").where("number", "==", randomNum).get();
                if (check.empty) isUnique = true;
            }

            await db.collection("participants").add({
                name: name, class: sClass, number: randomNum,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            localStorage.setItem('myLuckyNumber', randomNum);
            showMainUI(randomNum);
        } catch (e) {
            alert("L·ªói: " + e.message);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
