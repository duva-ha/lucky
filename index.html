<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Pro - H·ªçc Sinh</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; padding: 20px; }
        .card { background: #2d2d2d; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #444; }
        
        /* UI Quay S·ªë */
        .slot-row { display: flex; justify-content: center; gap: 5px; margin: 15px 0; }
        .slot { background: #000; width: 45px; height: 65px; border-radius: 8px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; }
        .spinning { color: #00ff00; border-color: #00ff00; }
        .final { color: #ffc107; border-color: #ffc107; }

        /* UI Chu√¥ng */
        #buzzerBtn { 
            width: 180px; height: 180px; border-radius: 50%; border: none;
            background: radial-gradient(#ff416c, #ff4b2b); color: white;
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px #b91d1d; transition: 0.1s; display: none; margin: 20px auto;
        }
        #buzzerBtn:active { transform: translateY(5px); box-shadow: 0 5px #b91d1d; }
        #buzzerBtn:disabled { background: #555; box-shadow: 0 5px #333; opacity: 0.5; }

        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; font-size: 1rem; }
        button.reg { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="regForm" style="max-width: 400px; margin: auto; background: white; padding: 30px; border-radius: 20px; color: #333;">
    <h2 style="margin-top:0">ƒêƒÇNG K√ù</h2>
    <input type="text" id="sName" placeholder="H·ªç v√† t√™n">
    <input type="text" id="sClass" value="10A7">
    <button class="reg" onclick="register()">THAM GIA NGAY</button>
</div>

<div id="mainUI" style="display:none; max-width: 450px; margin: auto;">
    <div class="card">
        <div style="font-size: 0.8rem; color: #888;">S·ªê MAY M·∫ÆN C·ª¶A EM</div>
        <div id="myNum" style="font-size: 2rem; color: #ffc107; font-weight: bold; letter-spacing: 3px;">------</div>
    </div>

    <div id="panelLucky" class="card">
        <div style="font-size: 0.8rem; color: #888;">K·∫æT QU·∫¢ QUAY S·ªê</div>
        <div class="slot-row">
            <div id="b1" class="slot">0</div><div id="b2" class="slot">0</div>
            <div id="b3" class="slot">0</div><div id="b4" class="slot">0</div>
            <div id="b5" class="slot">0</div><div id="b6" class="slot">0</div>
        </div>
        <div id="msgLucky" style="color: #ffc107; font-weight: bold;">ƒêang ch·ªù th·∫ßy...</div>
    </div>

    <div id="panelQuiz" class="card" style="display:none;">
        <div style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">PH·∫¶N THI TR·∫¢ L·ªúI NHANH</div>
        <button id="buzzerBtn" onclick="hitBuzzer()">B·∫§M<br>CHU√îNG</button>
        <div id="msgQuiz" style="color: #ffc107; font-weight: bold;">ƒê·ª£i l·ªánh t·ª´ Th·∫ßy</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    window.onload = () => {
        const saved = localStorage.getItem('myLuckyNumber');
        if(saved) showUI(saved);
        listenSystem();
    };

    function showUI(num) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('myNum').innerText = num;
    }

    function listenSystem() {
        // L·∫Øng nghe ƒë·ªïi ch·∫ø ƒë·ªô (Quay s·ªë <-> B·∫•m chu√¥ng)
        db.collection("system_status").doc("mode").onSnapshot(doc => {
            if(!doc.exists) return;
            const mode = doc.data().current;
            document.getElementById('panelLucky').style.display = mode === 'lucky' ? 'block' : 'none';
            document.getElementById('panelQuiz').style.display = mode === 'quiz' ? 'block' : 'none';
        });

        // L·∫Øng nghe l·ªánh quay
        db.collection("system_status").doc("current_draw").onSnapshot(async doc => {
            if(doc.exists && doc.data().status === "SPINNING") {
                await startSpin(doc.data().winningNumber);
            }
        });

        // L·∫Øng nghe l·ªánh chu√¥ng
        db.collection("system_status").doc("quiz_state").onSnapshot(doc => {
            if(!doc.exists) return;
            const btn = document.getElementById('buzzerBtn');
            const msg = document.getElementById('msgQuiz');
            if(doc.data().status === "OPEN") {
                btn.style.display = "block"; btn.disabled = false; msg.innerText = "B·∫§M NHANH N√ÄO!";
            } else if(doc.data().status === "CLOSED") {
                btn.style.display = "none"; msg.innerText = "ƒê√£ kh√≥a chu√¥ng";
            } else if(doc.data().winner) {
                btn.disabled = true; msg.innerText = "Ng∆∞·ªùi th·∫Øng: " + doc.data().winner;
            }
        });
    }

    async function startSpin(winNum) {
        document.getElementById('msgLucky').innerText = "‚ö° ƒêANG QUAY...";
        for(let i=0; i<6; i++) {
            const el = document.getElementById('b'+(i+1));
            el.classList.add('spinning');
            let start = Date.now();
            while(Date.now() - start < (2000 + i*500)) {
                el.innerText = Math.floor(Math.random()*10); await sleep(60);
            }
            el.innerText = winNum[i]; el.classList.remove('spinning'); el.classList.add('final');
        }
        if(localStorage.getItem('myLuckyNumber') === winNum) {
            document.getElementById('msgLucky').innerHTML = "üéä EM ƒê√É TR√öNG GI·∫¢I! üéä";
            if(navigator.vibrate) navigator.vibrate([200,100,200]);
        }
    }

    async function hitBuzzer() {
        const name = localStorage.getItem('studentName') || "H·ªçc sinh";
        const ref = db.collection("system_status").doc("quiz_state");
        try {
            await db.runTransaction(async (t) => {
                const doc = await t.get(ref);
                if(doc.data().status === "OPEN") {
                    t.update(ref, { status: "LOCKED", winner: name });
                    if(navigator.vibrate) navigator.vibrate(200);
                }
            });
        } catch(e) {}
    }

    async function register() {
        const name = document.getElementById('sName').value.trim();
        if(!name) return alert("Nh·∫≠p t√™n em ∆°i!");
        let num = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        await db.collection("participants").add({ name: name, class: document.getElementById('sClass').value, number: num });
        localStorage.setItem('myLuckyNumber', num);
        localStorage.setItem('studentName', name);
        showUI(num);
    }
</script>
</body>
</html>
