<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu√¢n B√≠nh Ng·ªç 2026 - Giviso Mega Luck</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --red: #b71c1c; --gold: #ffeb3b; --dark: #4a0000; --glass: rgba(0,0,0,0.85); }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle, #b71c1c 0%, #4a0000 100%); 
            color: white; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh;
        }
        .container { width: 100%; max-width: 480px; text-align: center; }
        
        /* Form ƒêƒÉng k√Ω */
        #regForm { background: white; padding: 25px; border-radius: 20px; color: #333; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: var(--red); text-align: center; font-size: 1.4rem; }
        input { width: 100%; padding: 12px; margin: 8px 0 18px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        .btn-reg { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        /* Th·∫ª th√¥ng tin c√° nh√¢n */
        .personal-card { background: var(--glass); padding: 15px; border-radius: 20px; border: 2px solid var(--gold); margin-bottom: 15px; }
        .my-num-box { font-size: 2.2rem; color: var(--gold); font-weight: 900; letter-spacing: 5px; margin: 5px 0; }
        .kara-info { font-style: italic; color: #ffccbc; border-top: 1px solid rgba(255,235,59,0.3); padding-top: 8px; font-size: 0.9rem; }

        /* Giao di·ªán 6 d√≤ng quay Mega */
        #panelLucky { display: none; margin-top: 10px; }
        .winner-row { 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            background: rgba(0,0,0,0.4); padding: 8px; border-radius: 12px; 
            margin-bottom: 8px; border: 1px solid rgba(255,235,59,0.2);
        }
        .row-label { font-size: 0.7rem; font-weight: 900; color: var(--gold); min-width: 35px; text-align: left; }
        .slot-group { display: flex; gap: 3px; }
        .slot { 
            width: 38px; height: 55px; background: #000; border: 1px solid #444; border-radius: 6px; 
            font-size: 2rem; font-weight: 900; display: flex; align-items: center; justify-content: center; color: #444;
        }
        .spinning { color: #00ff00; border-color: #00ff00; }
        .final { color: white; border-color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .match-row { background: rgba(40, 167, 69, 0.4); border-color: #28a745; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #luckyStatus { font-weight: bold; font-size: 1.1rem; color: #00ff00; margin-top: 10px; min-height: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <div id="regForm">
        <h2>üßß ƒêƒÇNG K√ù T·∫§T NI√äN üßß<br><small>ƒê√≥n Xu√¢n B√≠nh Ng·ªç 2026</small></h2>
        <label><b>H·ªå V√Ä T√äN</b></label>
        <input type="text" id="nameInp" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <label><b>B√ÄI H√ÅT KARAOKE</b></label>
        <input type="text" id="songInp" placeholder="T√™n b√†i h√°t b·∫°n mu·ªën g√≥p vui...">
        <button class="btn-reg" onclick="register()">ƒêƒÇNG K√ù THAM GIA</button>
    </div>

    <div id="mainUI" style="display: none;">
        <div class="personal-card">
            <div id="displayIdentity" style="font-weight:bold; color: var(--gold); text-transform: uppercase;">#0 - T√™n</div>
            <div style="font-size: 0.7rem; color: #ccc;">M√É S·ªê MAY M·∫ÆN:</div>
            <div id="displayMyNum" class="my-num-box">000000</div>
            <div id="displaySong" class="kara-info">Karaoke: </div>
        </div>

        <div id="panelLucky">
            <div id="megaUI">
                </div>
            <div id="luckyStatus"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");
    spinSound.loop = true;

    // T·∫°o giao di·ªán 6 d√≤ng l·ªìng s·ªë cho ng∆∞·ªùi tham gia
    const megaUI = document.getElementById('megaUI');
    for (let r = 1; r <= 6; r++) {
        megaUI.innerHTML += `
            <div class="winner-row" id="row${r}">
                <div class="row-label">GI·∫¢I ${r}</div>
                <div class="slot-group">
                    ${Array(6).fill(0).map((_, s) => `<div id="r${r}s${s+1}" class="slot">0</div>`).join('')}
                </div>
            </div>`;
    }

    async function register() {
        const name = document.getElementById('nameInp').value.trim();
        const song = document.getElementById('songInp').value.trim() || "Kh√¥ng ƒëƒÉng k√Ω";
        if(!name) return alert("Vui l√≤ng nh·∫≠p h·ªç t√™n!");

        const myNum = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
        const snap = await db.collection("participants").get();
        const stt = snap.size + 1;

        await db.collection("participants").add({
            name, song, number: myNum, stt, ts: Date.now()
        });

        localStorage.setItem('giviso_name', name);
        localStorage.setItem('giviso_song', song);
        localStorage.setItem('giviso_num', myNum);
        localStorage.setItem('giviso_stt', stt);
        showUI(name, song, myNum, stt);
    }

    function showUI(name, song, num, stt) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('displayIdentity').innerText = `#${stt} - ${name}`;
        document.getElementById('displayMyNum').innerText = num;
        document.getElementById('displaySong').innerText = "Karaoke: " + song;
        listenSystem();
    }

    function listenSystem() {
        db.collection("system_status").doc("current_draw").onSnapshot(async d => {
            if(!d.exists) return;
            const data = d.data();
            
            if(data.status === "SPINNING" && data.winners) {
                document.getElementById('panelLucky').style.display = 'block';
                runMegaSpinHS(data.winners);
            }
        });
    }

    async function runMegaSpinHS(winners) {
        spinSound.currentTime = 0; spinSound.play().catch(()=>{});
        document.getElementById('luckyStatus').innerText = "‚ö° ƒêANG QUAY TH∆Ø·ªûNG...";
        const myNum = localStorage.getItem('giviso_num');

        // Reset c√°c d√≤ng
        for(let r=1; r<=6; r++) document.getElementById(`row${r}`).classList.remove('match-row');

        let promises = winners.map((winner, rIdx) => {
            return new Promise(async (resolve) => {
                const r = rIdx + 1;
                const winNum = winner.number;
                
                for (let s = 1; s <= 6; s++) {
                    const el = document.getElementById(`r${r}s${s}`);
                    el.classList.add('spinning'); el.classList.remove('final');
                    let start = Date.now();
                    // Kh·ªõp th·ªùi gian v·ªõi m√°y th·∫ßy
                    while (Date.now() - start < (2000 + rIdx * 800 + s * 200)) {
                        el.innerText = Math.floor(Math.random() * 10);
                        await new Promise(res => setTimeout(res, 60));
                    }
                    el.innerText = winNum[s-1];
                    el.classList.remove('spinning'); el.classList.add('final');
                }

                // Ki·ªÉm tra tr√∫ng th∆∞·ªüng ngay khi d√≤ng n√†y d·ª´ng
                if(winNum === myNum) {
                    document.getElementById(`row${r}`).classList.add('match-row');
                    document.getElementById('luckyStatus').innerText = "üéä B·∫†N ƒê√É TR√öNG GI·∫¢I " + r + "! üéä";
                    winSound.play();
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                }
                resolve();
            });
        });

        await Promise.all(promises);
        spinSound.pause();
        if(!winners.some(w => w.number === myNum)) {
            document.getElementById('luckyStatus').innerText = "Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau!";
            document.getElementById('luckyStatus').style.color = "#aaa";
        }
    }

    window.onload = () => {
        const n = localStorage.getItem('giviso_name');
        if(n) showUI(n, localStorage.getItem('giviso_song'), localStorage.getItem('giviso_num'), localStorage.getItem('giviso_stt'));
    };
</script>
</body>
</html>
