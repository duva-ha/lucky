<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Student - D√≤ S·ªë T·∫•t Ni√™n</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #ffeb3b; --bg: #8b0000; --card: #4a0000; --accent: #ffeb3b; --gold: #ffd700; }
        body { font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle, #8b0000 0%, #4a0000 100%); color: white; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 480px; text-align: center; }
        
        /* Th√¥ng tin c√° nh√¢n */
        .info-card { background: var(--card); padding: 15px; border-radius: 20px; border: 2px solid var(--accent); margin-bottom: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
        .my-num { font-size: 2.2rem; color: var(--accent); font-weight: 900; letter-spacing: 3px; text-shadow: 0 0 10px rgba(255,235,59,0.5); }

        /* B·∫£ng 6 d√£y s·ªë tr√∫ng gi·∫£i */
        .mega-draw-panel { background: rgba(0,0,0,0.6); border-radius: 20px; padding: 15px; border: 1px solid var(--gold); margin-bottom: 20px; }
        .draw-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed rgba(255,215,0,0.3); }
        .draw-row:last-child { border-bottom: none; }
        .row-label { font-size: 0.8rem; font-weight: bold; color: var(--gold); min-width: 50px; text-align: left; }
        .row-number { font-family: monospace; font-size: 1.5rem; font-weight: 900; letter-spacing: 2px; color: #aaa; transition: 0.3s; }
        .row-number.active { color: #00ff00; }
        .row-number.match { color: white; background: #28a745; padding: 2px 8px; border-radius: 5px; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Reg Form */
        #regForm { background: white; padding: 30px; border-radius: 25px; color: #333; text-align: left; margin-top: 20px; }
        input[type=text] { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
        .btn-reg { width: 100%; padding: 18px; background: #8b0000; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="regForm">
        <h2 style="text-align:center; color:#8b0000">üßß D√í S·ªê T·∫§T NI√äN üßß</h2>
        <input type="text" id="nameInp" placeholder="H·ªç v√† T√™n">
        <input type="text" id="classInp" placeholder="L·ªõp / B·ªô ph·∫≠n">
        <button class="btn-reg" onclick="register()">NH·∫¨N M√É & CH·ªú QUAY</button>
    </div>

    <div id="mainUI" style="display: none;">
        <div class="info-card">
            <div id="displayIdentity" style="font-weight:bold; color: var(--accent);">T√äN - L·ªöP</div>
            <div style="font-size: 0.7rem; color: #ccc;">M√É S·ªê C·ª¶A B·∫†N:</div>
            <div id="displayMyNum" class="my-num">000000</div>
        </div>

        <div class="mega-draw-panel">
            <div style="font-size: 0.9rem; font-weight: 900; color: var(--gold); margin-bottom: 10px;">üèÜ 6 D√ÉY S·ªê MAY M·∫ÆN üèÜ</div>
            <div id="drawRows">
                <div class="draw-row"><span class="row-label">GI·∫¢I 1</span><span id="win1" class="row-number">------</span></div>
                <div class="draw-row"><span class="row-label">GI·∫¢I 2</span><span id="win2" class="row-number">------</span></div>
                <div class="draw-row"><span class="row-label">GI·∫¢I 3</span><span id="win3" class="row-number">------</span></div>
                <div class="draw-row"><span class="row-label">GI·∫¢I 4</span><span id="win4" class="row-number">------</span></div>
                <div class="draw-row"><span class="row-label">GI·∫¢I 5</span><span id="win5" class="row-number">------</span></div>
                <div class="draw-row"><span class="row-label">GI·∫¢I 6</span><span id="win6" class="row-number">------</span></div>
            </div>
            <div id="luckyStatus" style="margin-top:15px; font-weight:bold; color:#00ff00; height:1.2em;"></div>
        </div>
        
        <p style="font-size: 0.7rem; color: #aaa;">D√£y s·ªë s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi th·∫ßy quay s·ªë tr√™n s√¢n kh·∫•u.</p>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");

    window.onload = () => {
        const n = localStorage.getItem('studentName'), c = localStorage.getItem('studentClass'), num = localStorage.getItem('myLuckyNumber');
        if(n && num) showUI(n, c, num);
        listenSystem();
    };

    function register() {
        const n = document.getElementById('nameInp').value, c = document.getElementById('classInp').value;
        if(!n || !c) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        const num = Math.floor(Math.random()*1000000).toString().padStart(6,'0');
        db.collection("participants").add({ name: n, class: c, number: num, ts: Date.now() });
        localStorage.setItem('studentName', n); localStorage.setItem('studentClass', c); localStorage.setItem('myLuckyNumber', num);
        showUI(n, c, num);
    }

    function showUI(n, c, num) {
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        document.getElementById('displayIdentity').innerText = n.toUpperCase() + " - " + c.toUpperCase();
        document.getElementById('displayMyNum').innerText = num;
    }

    function listenSystem() {
        // L·∫Øng nghe k·∫øt qu·∫£ t·ª´ m√°y th·∫ßy (C·∫ßn m√°y th·∫ßy g·ª≠i danh s√°ch winners l√™n Firestore)
        db.collection("system_status").doc("current_draw").onSnapshot(async d => {
            if(!d.exists) return;
            const data = d.data();
            
            if(data.status === "SPINNING") {
                spinSound.play().catch(()=>{});
                // Hi·ªáu ·ª©ng nh·∫£y s·ªë gi·∫£ tr√™n m√°y HS cho k·ªãch t√≠nh
                startFakeSpin();
            } else if (data.status === "DONE" && data.winners) {
                spinSound.pause();
                displayWinners(data.winners);
            }
        });
    }

    function startFakeSpin() {
        const rows = document.querySelectorAll('.row-number');
        rows.forEach(r => r.classList.add('active'));
        document.getElementById('luckyStatus').innerText = "‚ö° ƒêANG D√í S·ªê...";
    }

    function displayWinners(winners) {
        const myNum = localStorage.getItem('myLuckyNumber');
        let matched = false;

        winners.forEach((win, i) => {
            const el = document.getElementById(`win${i+1}`);
            el.innerText = win.number;
            el.classList.remove('active');
            
            if(win.number === myNum) {
                el.classList.add('match');
                matched = true;
            }
        });

        if(matched) {
            document.getElementById('luckyStatus').innerText = "üéä CH√öC M·ª™NG! B·∫†N ƒê√É TR√öNG GI·∫¢I! üéä";
            winSound.play();
            if(navigator.vibrate) navigator.vibrate([500,200,500]);
        } else {
            document.getElementById('luckyStatus').innerText = "CH√öC B·∫†N MAY M·∫ÆN L·∫¶N SAU!";
            document.getElementById('luckyStatus').style.color = "#aaa";
        }
    }
</script>
</body>
</html>
